<ion-header mode="ios" class="ion-no-border [--background:theme(colors.fundo-neutro)]">
  <ion-toolbar class="[--background:theme(colors.fundo-neutro)]">
    <ion-buttons slot="start">
      <ion-avatar class="w-8 h-8 ml-2 border-2 border-azul-sereno">
        <img src="assets/avatars/placeholder.png">
      </ion-avatar>
    </ion-buttons>
    <ion-title class="text-texto-profundo font-bold">Planejamento Semanal</ion-title>
    <ion-buttons slot="end">
      <ion-button >
        <ion-icon class="text-texto-suave" slot="icon-only" name="notifications"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar class="[--background:theme(colors.fundo-neutro)] px-2 pt-1 pb-2">
    <ion-item lines="none" class="[--background:transparent] text-sm w-auto">
      <ion-select [(ngModel)]="selectedStudentId" (ionChange)="loadSchedule()"
        interface="popover" class="text-texto-profundo font-medium" placeholder="Selecione um aluno">
        <ion-select-option *ngFor="let student of (students$ | async)" [value]="student.id">
          {{student.name}}
        </ion-select-option>
        <ion-select-option [value]="'all'">Todos os alunos</ion-select-option>
      </ion-select>
    </ion-item>
  </ion-toolbar>

  
  <div *ngIf="!isCurrentWeek" class="bg-fundo-neutro px-4 pb-2 text-center">
    <a (click)="goToCurrentWeek()" class="text-xs text-azul-sereno font-medium cursor-pointer hover:underline flex items-center justify-center gap-1">
      <ion-icon name="calendar-number"></ion-icon>
      Ir para a semana atual
    </a>
  </div>

  <ion-toolbar class="[--background:theme(colors.fundo-neutro)] px-4 pb-2">
    <div class="flex justify-between items-center">
      <ion-button fill="clear" (click)="changeWeek(-1)">
        <ion-icon class="text-texto-suave" slot="icon-only" name="chevron-back"></ion-icon>
      </ion-button>
      <span class="text-texto-profundo font-medium text-sm">{{weekDisplay}}</span>
      <ion-button fill="clear" (click)="changeWeek(1)">
        <ion-icon class="text-texto-suave" slot="icon-only" name="chevron-forward"></ion-icon>
      </ion-button>
    </div>

  </ion-toolbar>


</ion-header>

<ion-content [fullscreen]="true" class="[--background:theme(colors.fundo-neutro)]">
  <div class="p-4 pt-0">

    <ion-button expand="block" (click)="saveAsTemplate()"
      class="h-10 text-base normal-case [--background:theme(colors.verde-crescimento)] text-white shadow mb-4">
      <ion-icon name="bookmark" slot="start"></ion-icon>
      Salvar como modelo
    </ion-button>

    <div *ngIf="isLoading" class="text-center py-10">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p class="text-texto-suave mt-2">Carregando cronograma...</p>
    </div>

    
    <div *ngIf="!isLoading && scheduleIsEmpty" class="text-center py-10 px-6 bg-white rounded-xl shadow-sm">
      <ion-icon name="calendar-clear" class="text-4xl text-texto-suave mb-3"></ion-icon>
      <h3 class="font-semibold text-texto-profundo mb-1">Cronograma vazio</h3>
      <p class="text-sm text-texto-suave">Clique no '+' para agendar a primeira aula.</p>
    </div>

    <div *ngIf="!(isLoading ?? false) && !(scheduleIsEmpty ?? true) && scheduleGroupedByDay" class="space-y-5">
      <div *ngFor="let day of weekDays" class="relative">
        <ng-container *ngIf="scheduleGroupedByDay[day.value] as aulasDoDia">
          <div class="flex justify-between items-baseline mb-2 pl-4">
            <h2 class="text-lg font-bold text-texto-profundo">{{day.label}}</h2>
            <span class="text-xs text-texto-suave">{{getDayDate(day.value) | date:'dd MMM'}}</span>
          </div>
          <div class="space-y-2">
            <ion-card *ngFor="let aula of aulasDoDia" button="true"
              class="flex flex-col justify-center m-0 mb-2 rounded-xl shadow-sm bg-white"
              [style.height.px]="getCardHeight(aula.start_time, aula.end_time)">
              <ion-card-content class="flex items-center space-x-3 p-3 h-full">
                <div class="w-1.5 h-12 rounded-full bg-azul-sereno self-stretch" [style.background-color]="getSubjectColor(aula.subject_name)"></div>
                <div class="flex-grow"  (click)="openEditModal(aula)">
                  <p class="text-xs text-texto-suave">{{formatTime(aula.start_time)}} - {{formatTime(aula.end_time)}}</p>
                  <h3 class="font-semibold text-texto-profundo">{{aula.subject_name}}</h3>
                  <p *ngIf="selectedStudentId === 'all'" class="text-xs text-texto-suave"> {{aula.student_name}}</p>
                  <div *ngIf="(aula.status === 'completed' || aula.status === 'missed') && aula.log_notes"
                        class="bg-yellow-50 rounded-md border border-yellow-100 flex items-start gap-1 max-w-full overflow-hidden scale-75 origin-left">
                    <ion-icon name="document-text" class="text-yellow-600 text-xs mt-0.5 flex-shrink-0"></ion-icon>
                    <p class="text-[10px] text-texto-profundo italic leading-none line-clamp-2">
                      {{aula.log_notes.length > 25 ? (aula.log_notes | slice:0:25) + '...' : aula.log_notes}}
                    </p>
                  </div>
                </div>
                <div class="flex items-center space-x-1" (click)="$event.stopPropagation()">
                  <ion-avatar class="w-6 h-6 border border-linha-sutil">
                    <img [src]="'assets/avatars/'+(aula.responsible_avatar_id || 'placeholder.png')" alt="avatar do responsável"
                      class="rounded-full w-full h-full object-cover bg-gray-200">
                  </ion-avatar>
                  
                  <ion-chip [color]="aula.status === 'completed' ? 'success' : (aula.status === 'missed'? 'danger' : 'warning')" class="normal-case text-xs h-6 px-2 m-0">
                    {{aula.status === 'completed' ? 'Concluída' : (aula.status === 'missed' ? 'Não Realizada' : 'Pendente')}}
                  </ion-chip>
                  
                  <ion-button fill="clear" (click)="openRegistrarModal(aula, getDayDate(day.value))">
                    <ion-icon
                      name="checkmark-circle" class="text-lg"
                      [color]="aula.status === 'completed' ? 'success' : 'medium'"
                    ></ion-icon>
                  </ion-button>
                </div>
              </ion-card-content>
            </ion-card>

          </div>

        </ng-container>
      </div>
    </div>

  </div>


  <ion-fab slot="fixed" vertical="bottom" horizontal="end" class="m-4">
    <ion-fab-button (click)="openAddModal()" class="[--background:theme(colors.amarelo-foco)] rounded-full text-texto-profundo shadow-lg">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>

  </ion-fab>
</ion-content>
