<ion-header class="ion-no-border">
  <ion-toolbar class="[--background:theme(colors.fundo-neutro)]">
    <ion-title class="text-texto-profundo font-medium text-center">{{isEditMode ? 'Editar Avaliação' : 'Nova Avaliação'}}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss(null)">
        <ion-icon name="close" slot="icon-only" class="text-texto-suave"> </ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>  
</ion-header>

<ion-content class="[--background:theme(colors.fundo-neutro)]">

  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="p-4 space-y-4">
    <div class="bg-white rounded-lg p-3 shadow-sm">
      <ion-label position="stacked" class="text-xs text-texto-suave mb-1 ml-1">Título da Avaliação</ion-label>
      <ion-input formControlName="title" placeholder="Ex.: Prova Bimestral de Matemática" class="text-base"></ion-input>
      <div *ngIf="f['title'].invalid && f['title'].touched" class="text-vermelho-erro text-xs ml-1 mt-1">Obrigatório.</div>
    </div>

    <div class="bg-white rounded-lg p-3 shadow-sm">
      <ion-label position="stacked" class="text-xs text-texto-suave mb-1 ml-1">Data da Avaliação</ion-label>
      <ion-item button="true" details="false" lines="none" id="open-date-modal" class="border border-linha-sutil rounded-md h-10 px-3">
        <ion-label class="text-sm">{{ f['assessment_date'].value ? (f['assessment_date'].value | date:'dd/MM/yyyy') : 'dd/mm/aaaa' }}</ion-label>
        <ion-icon name="calendar" slot="end" class="text-texto-suave"></ion-icon>
      </ion-item>
      <ion-modal trigger="open-date-modal" [keepContentsMounted]="true">
        <ng-template>
          <ion-datetime #assessmentDatePicker presentation="date" formControlName="assessment_date" (ionChange)="f['assessment_date'].markAsDirty()" [min]="f['assessment_date'].value || ''">
            <ion-buttons slot="buttons">
              <ion-button color="danger" (click)="assessmentDatePicker.reset(); assessmentDatePicker.confirm(true)">Limpar</ion-button>
              <ion-button color="medium" (click)="assessmentDatePicker.cancel(true)">Cancelar</ion-button>
              <ion-button color="primary" (click)="assessmentDatePicker.confirm(true)">OK</ion-button>
            </ion-buttons>
          </ion-datetime>
        </ng-template>
      </ion-modal>
      <div *ngIf="f['assessment_date'].invalid && f['assessment_date'].touched" class="text-vermelho-erro text-xs ml-1 mt-1">Obrigatório.</div>
    </div>

    <div class="bg-white rounded-lg p-3 shadow-sm">
      <ion-label position="stacked" class="text-xs text-texto-suave mb-1 ml-1">Nota/Conceito</ion-label>
      <ion-input formControlName="grade" placeholder="Resultado da avaliação" class="text-base"></ion-input>
      <div *ngIf="f['grade'].invalid && f['grade'].touched" class="text-vermelho-erro text-xs ml-1 mt-1">Obrigatório.</div>
    </div>

    <div class="bg-white rounded-lg p-3 shadow-sm">
      <ion-label position="stacked" class="text-xs text-texto-suave mb-1 ml-1">Anotações</ion-label>
      <ion-textarea formControlName="notes" placeholder="Comentários sobre o desempenho..." [autoGrow]="true" rows="3"></ion-textarea>
    </div>

    <div>
      <ion-label class="text-sm text-texto-profundo font-medium block mb-2">Fotos e Documentos</ion-label>

      <input
        type="file"
        #fileInput
        (change)="onFileSelected($event)"
        style="display: none;"
        accept="image/*,application/pdf"
        multiple
      />

      
      <div class="flex gap-2 overflow-x-auto pb-2">
        <div class="w-20 h-20 rounded-lg border-2 border-dashed border-linha-sutil flex flex-col items-center justify-center text-texto-suave cursor-pointer bg-gray-50 hover:bg-gray-100"
          (click)="fileInput.click()">
          <ion-spinner *ngIf="isUploading" name="crescent"></ion-spinner>
          <div *ngIf="!isUploading" class="flex flex-col items-center">
            <ion-icon name="camera" class="text-2xl mb-1"></ion-icon>
            <span class="text-[10px]">Adicionar</span>
          </div>          
        </div>

        <div *ngFor="let att of attachments" class="relative w-20 h-20 flex-shrink-0">
          <ng-container *ngIf="isImage(att)">
            <img [src]="att.file_url" class="w-full h-full object-cover rounded-lg border border-linha-sutil"
                  (click)="openImage(att.file_url)">
          </ng-container>
          <ng-container *ngIf="!isImage(att)">
            <div *ngIf="!att.file_type.startsWith('image')" class="w-full h-full flex items-center justify-center bg-gray-100 rounded-lg border border-linha-sutil text-texto-profundo"
                        (click)="openImage(att.file_url)">
              <ion-icon name="document-text" class="text-2xl"></ion-icon>
              <span class="text-[8px] w-full truncate text-center">{{ att.file_name?.length > 10 ? (att.file_name | slice:0:10) + '...' : att.file_name }}</span>
            </div>
          </ng-container>
          
        </div>

      </div>
    </div>

  <div class="flex gap-3">
    <ion-button *ngIf="isEditMode" 
                fill="clear" 
                color="danger" 
                class="flex-none normal-case" 
                (click)="deleteAssessment()">
                <ion-icon name="trash" slot="icon-only"></ion-icon>
    </ion-button>

    <ion-button fill="outline" expand="block" class="flex-1 text-texto-suave border-linha-sutil normal-case" (click)="dismiss(null)">
      Cancelar
    </ion-button>
    
    <ion-button type="submit" expand="block" class="flex-1 [--background:theme(colors.azul-sereno)] text-white normal-case" [disabled]="form.invalid">
      <ion-icon name="save" slot="start"></ion-icon> Salvar
    </ion-button>
  </div>

    
    
  </form>


 

</ion-content>