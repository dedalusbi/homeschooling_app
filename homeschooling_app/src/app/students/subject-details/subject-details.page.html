<ion-header mode="ios" class="ion-no-border [--background:theme(colors.fundo-neutro)]">
  <ion-toolbar class="[--background:theme(colors.fundo-neutro)]">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="'/manage-subjects/'+studentIdParam" class="text-texto-profundo"></ion-back-button>
    </ion-buttons>
    <ion-title class="text-texto-profundo font-bold">{{(subject$ | async)?.data?.name || 'Detalhes'}}</ion-title>
    <ion-buttons slot="end" *ngIf="(subject$ | async)?.data?.status === 'active'">
      <ion-button (click)="goToEditSubject()" class="text-azul-sereno">
        <ion-icon slot="icon-only" name="create"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="end" *ngIf="(subject$ | async)?.data?.status === 'completed'" style="opacity: 0;">
      <ion-button><ion-icon slot="icon-only" name="create"></ion-icon></ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>



<ion-content [fullscreen]="true" class="[--background:theme(colors.fundo-neutro)]">
  <div *ngIf="subject$ | async as subjectWrapper; else loadingDetails">
    <ng-container *ngIf="subjectWrapper.data as subject">
      <div class="px-4 pt-2 pb-4">
        <div class="bg-azul-sereno text-white rounded-xl shadow-lg p-4">
          <div class="flex items-center space-x-3 mb-3">
            <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
              <ion-icon [name]="getIconForSubject(subject.name)" class="text-xl"></ion-icon>
            </div>
            <div>
              <div class="flex items-center gap-1">
                <h2 class="font-bold text-xl">{{subject.name}}</h2>
                <ion-icon name="information-circle" class="text-lg opacity-80 cursor-pointer" (click)="showDescription(subject.description)"></ion-icon>
              </div>
              <p class="text-xs opacity-80">
                {{subject.aulas_concluidas || 0}} aulas concluídas • {{subject.progresso || 0}}% progresso
              </p>
            </div>
          </div>
          <div class="w-full bg-black/20 rounded-full h-1.5">
            <div class="bg-white h-1.5 rounded-full" [style.width.%]="subject.progresso || 0"></div>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg p-4 shadow-sm mb-6" *ngIf="subject.teaching_materials">
        <h3 class="font-semibold text-texto-profundo mb-2">Material Didático</h3>
        <p class="text-texto-suave text-sm whitespace-pre-wrap">{{subject.teaching_materials}}</p>
      </div>

     <div class="px-4 mb-6">
      <h3 class="text-lg font-semibold text-texto-profundo mb-2">Histórico de Atividades</h3>

      <div *ngIf="subject.history && subject.history.length > 0; else noHistory" class="space-y-2">
          <ion-card *ngFor="let activity of subject.history" class="m-0 rounded-xl shadow-sm bg-white">
            <ion-card-content class="flex items-center space-x-3 p-3">
                <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center">
                  <ion-icon name="checkmark-circle-outline" class="text-lg text-green-600"></ion-icon>
                </div>
                <div class="flex-grow">
                  <h4 class="font-medium text-texto-profundo">Aula Realizada</h4>
                  <p class="text-xs text-texto-suave">{{ activity.log_date | date:'dd/MM/yyyy' }}</p>
                  <p *ngIf="activity.notes" class="text-xs text-gray-500 mt-1 line-clamp-1">
                    {{ activity.notes }}
                  </p>
                </div>
                <ion-chip outline="true" color="success" class="text-xs h-6 px-2">Concluída</ion-chip>
            </ion-card-content>
          </ion-card>
      </div>

      <ng-template #noHistory>
          <p class="text-sm text-texto-suave italic text-center py-4">Nenhuma atividade registrada ainda.</p>
      </ng-template>
    </div>

      <div class="px-4 mb-6">
        <div class="flex justify-between items-center mb-2">
          <h3 class="text-lg font-semibold text-texto-profundo">Avaliações</h3>
          <ion-button fill="solid" size="small" (click)="goToAddEvaluation()" class="[--background:theme(colors.amarelo-foco)] text-white text-xs normal-case h-7 shadow-sm">
            <ion-icon name="add" slot="start"></ion-icon>
            Adicionar
          </ion-button>
        </div>
        <div class="space-y-2">
          <ion-card button="true" (click)="goToEvaluationDetails('1')" class="m-0 rounded-xl shadow-sm bg-white">
            <ion-card-content class="flex items-center space-x-3 p-3">
              <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center">
                <ion-icon name="document-text" class="text-lg text-green-600"></ion-icon>
              </div>
              <div class="flex-grow">
                <h4 class="font-medium text-texto-profundo">Prova Mensal</h4>
                <p class="text-xs text-texto-suave">Realizada em 15/10/2024</p>
              </div>
              <ion-chip color="success" class="text-sm font-bold h-7 w-7 flex items-center justify-center">10</ion-chip>
              <ion-icon name="chevron-forward" class="text-texto-suave text-lg ml-1"></ion-icon>
            </ion-card-content>
          </ion-card>
        </div>
      </div>

    </ng-container>
  </div>


  <ng-template #loadingDetails>
    <div class="flex items-center justify-center h-64">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
    </div>
  </ng-template>

  <ion-footer class="ion-no-border [--background:theme(colors.fundo-neutro)] safe-area-bottom">
    <ion-toolbar class="[--background:theme(colors.fundo-neutro)] p-4">
      <ng-container *ngIf="(subject$ | async)?.data as subject">
        <div *ngIf="subject.status === 'active'" class="space-y-2">
          <ion-button
            expand="block" (click)="confirmFinishSubject()" class="h-12 text-base normal-case [--background:theme(colors.verde-crescimento)] text-white shadow-lg">
            Finalizar Matéria
          </ion-button>
        </div>
        <div *ngIf="subject.status == 'completed'" class="space-y-2">
          <ion-button *ngIf="subject.completion_report" expand="block" (click)="viewFinalReportAlert()" fill="outline" class="h-12 text-base normal-case [--color:theme(colors.azul-sereno)] [--border-color:theme(colors.azul-sereno)] shadow-lg">
            Ver Relatório Final
          </ion-button>
          <ion-button expand="block" (click)="reactivateSubject()" class="h-12 text-base normal-case [--background:theme(colors.azul-sereno)] text-white shadow-lg">
            Reativar Matéria
          </ion-button>
        </div>
        <ion-button expand="block" fill="clear" color="danger" (click)="confirmDeleteSubject()" class="mt-2 text-sm normal-case">
          <ion-icon name="trash" slot="start"></ion-icon>
          Remover Matéria Permanentemente
        </ion-button>
      </ng-container>
    </ion-toolbar>
  </ion-footer>
</ion-content>
