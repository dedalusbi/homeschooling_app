<ion-header mode="ios" class="[--background:theme(colors.fundo-neutro)]">
  <ion-toolbar class="[--background:theme(colors.fundo-neutro)]">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/alunos" class="text-texto-profundo"></ion-back-button>
    </ion-buttons>
    <ion-title class="text-texto-profundo text-center">{{(student$ | async)?.data?.name || 'Detalhes' }}  </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="goToEditStudent()" class="[--color:theme(colors.azul-sereno)] font-medium normal-case">
        <ion-icon slot="icon-only" name="create-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="[--background:theme(colors.fundo-neutro)]">
  <!--Exibe apenas quando os dados do aluno forem carregados-->
  <div *ngIf="(student$ | async)?.data as student; else loadingDetails" class="p-6 text-texto-profundo md:max-w-md md:mx-auto md:pt-12">

    <!--Foto do aluno-->
    <div class="flex justify-center mb-6">
      <div class="relative w-24 h-24">
        <div class="w-full h-full rounded-full bg-gray-200 border-2 border-verde-crescimento flex items-center justify-center text-gray-400 overflow-hidden">
          <img *ngIf="student.avatar_id"
          [src]="'assets/avatars/' + student.avatar_id" alt="Avatar"
          class="rounded-full w-full h-full object-cover">
          <ion-icon *ngIf="!student.avatar_id" name="person" class="text-4xl"></ion-icon>
        </div>
      </div>
    </div>


    <!--Formulário-->
    <div class="space-y-5">
      <!--Nome Completo-->
      <div class="bg-white rounded-lg p-3 shadow-sm">
        <ion-label position="stacked" class="text-xs text-texto-suave mb-1 ml-1">Nome Completo</ion-label>
        <p class="text-base py-1 px-1">{{student.name}}</p>
        <!--ion-input-->
      </div>

      <!--Data de nascimento-->
      <div class="bg-white rounded-lg p-3 shadow-sm">
        <ion-label position="stacked" class="text-xs text-texto-suave mb-1 ml-1">Data de Nascimento</ion-label>
        <div class="flex items-center">
          <p class="text-base py-1 px-1 flex-grow">{{student.birth_date ? (student.birth_date | date:'dd/MM/yyyy' : '' : 'pt-BR') : 'Não informado'}}</p>
          <!--ion-datetime futuramente-->
          <ion-icon name="calendar" class="text-texto-suave text-xl ml-auto pl-2"></ion-icon>
        </div>
      </div>

      <!--Nível escolar-->
      <div class="bg-white rounded-lg p-3 shadow-sm">
        <ion-label position="stacked" class="text-xs text-texto-suave mb-1 ml-1">Nível escolar</ion-label>
        <p class="text-base py-1 px-1">{{student.grade_level || 'Não informado'}}</p>
        <!--ion-input...-->

      </div>

      <!--Individualidades-->
      <div class="bg-white rounded-lg p-3 shadow-sm">
        <ion-label position="stacked" class="text-xs text-texto-suave mb-2 ml-1">Individualidades</ion-label>
        <div *ngIf="student.individualities && student.individualities.length>0; else noIndividualities" class="flex flex-wrap gap-2 pt-1">
          <ion-chip *ngFor="let ind of student.individualities" outline="true" class="text-xs border-linha-sutil">
            <ion-label class="text-texto-profundo"><strong>{{ind.type}}: </strong> {{ind.description}}</ion-label>
          </ion-chip>
        </div>
        <ng-template #noIndividualities>
          <p class="text-sm">Nenhuma característica informada.</p>
        </ng-template>
      </div>


    </div>


    <!--Seção Responsáveis (placeholder)-->
    <div class="mt-8">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-lg font-semibold text-texto-profundo">Responsáveis</h2>
        <span class="text-xs text-texto-suave bg-gray-100 px-2 py-0.5 rounded-full">
          {{student.guardians?.length || 0 }}/3
        </span>
      </div>
      <!--Lista de responsáveis -->
      <div class="space-y-2">
        <ion-card *ngFor="let guardian of student.guardians" class="m-0 rounded-xl shadow-sm bg-white">
          <ion-card-content class="flex items-center space-x-3 p-3">
            <ion-avatar class="w-10 h-10 border border-linha-sutil">
              <img [src]="'assets/avatars/'+(guardian.avatar_id || 'placeholder.png')" alt="Avatar" class="object-cover">
            </ion-avatar>
            <div class="flex-grow">
              <h3 class="font-medium text-texto-profundo">{{guardian.name}}
                <span *ngIf="guardian.user_id === currentUserId" class="text text-texto-suave font-normal"> (Você)</span>
              </h3>
              <p class="text-xs text-texto-suave">{{guardian.email}}</p>
            </div>
            <ion-chip *ngIf="guardian.user_id === currentUserId" color="sucess" outline="true" class="text-xs h-5 px-2">Principal</ion-chip>
            <ion-button *ngIf="guardian.user_id !== currentUserId" fill="clear" color="danger" size="small"
              >
              <ion-icon slot="icon-only" name="close"></ion-icon>

            </ion-button>
          </ion-card-content>
        </ion-card>
      </div>
      <!--Botão convidar (placeholder)-->
      <ion-button expand="block" shape="round" class="meu-botao-gradiente h-12 text-base normal-case text-white mt-4 shadow-md" (click)="inviteGuardian()">
        <ion-icon name="add" slot="start"></ion-icon>
        Convidar Responsável
      </ion-button>
    </div>



    <!--Remover aluno-->

    <div class="mt-10 pt-6 border-t border-linha-sutil">
      <ion-button expand="block" fill="outline" color="danger" (click)="confirmDeleteStudent(student.id, student.name)" class="h-10 text-sm normal-case">
        <ion-icon name="trash" slot="start"></ion-icon>
        Remover aluno
      </ion-button>
    </div>


  </div>


  <ng-template #loadingDetails>
    <div class="flex justify-center items-center h-dull">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
    </div>
  </ng-template>
</ion-content>
